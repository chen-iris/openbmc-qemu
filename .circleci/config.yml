version: 2.1
jobs:
    build-and-test:
        docker:
            - image: crops/poky:latest
              user: root
        steps:
            - run:
                name: "Install dependencies"
                command: |
                    apt update
                    apt install -y ninja-build \
                                   pkg-config \
                                   libglib2.0-dev \
                                   libpixman-1-dev
            - checkout
            - run:
                name: "configure"
                command: |
                    ./configure --target-list=arm-softmmu
            - run:
                name: "make"
                command: |
                    make
            - run:
                name: "make check"
                command: |
                    make check
            - run:
                name: "check patch"
                command: |
                    git remote add upstream https://github.com/qemu/qemu
                    git fetch upstream
                    ./scripts/checkpatch.pl --branch $(git merge-base upstream/master master)...master

workflows:
    version: 2.1
    everything:
        jobs:
            - build-and-test
